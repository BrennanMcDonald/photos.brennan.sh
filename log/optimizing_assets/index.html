<!doctype html><html><head><title>photos.brennan.sh</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robot content="noimageindex"><meta name=description content="photos.brennan.sh is a photography blog"><meta property="og:description" content="photos.brennan.sh is a photography blog"><meta property="og:site_name" content="photos.brennan.sh"><link rel=icon href=/favicon.svg><link rel=stylesheet href=https://photos.brennan.sh/css/bundle.min.a969df73a2e4412fd327742e002f7338c69bdc7206ca59b822e357f1faf8c657.css integrity="sha256-qWnfc6LkQS/TJ3QuAC9zOMab3HIGylm4IuNX8fr4xlc="></head><body><div class=container><div class=row><div class="three columns"><a class=title href=/>photos.brennan.sh</a></div></div><div class=row><div class="ten columns log"><h2>Optimizing Asset Delivery</h2><p>I&rsquo;ve wanted to improve the CSS and JavaScript portions of this website for a
while. The main items I want to address are:</p><ul><li>Removing JavaScript from HTML templates</li><li>Find a better way to inject site content into JavaScript</li><li>Bundle all CSS into a single file</li><li>Minify and fingerprint CSS and JavaScript</li></ul><p>I initially intended to plug various CSS and JavaScript processing tools into the
Docker build pipeline, but that quickly spiraled out of control when <code>npm</code> got involved.
Then I discovered <a href=https://gohugo.io/hugo-pipes/introduction/>Hugo Pipes</a>, which
solves these problems natively.</p><h2 id=heading></h2><h2 id=removing-javascript-from-html-templates>Removing JavaScript from HTML templates</h2><p>I started by extracting all JavaScript from HTML and appending it to a single <code>./assets/js/main.js</code> file.
Then from HTML I load, process, and render the script:</p><pre><code>{{ $main := resources.Get &quot;js/main.js&quot; | js.Build | minify | fingerprint }}
&lt;script type=&quot;text/javascript&quot; src=&quot;{{ $main.RelPermalink }}&quot; defer&gt;&lt;/script&gt;
</code></pre><p>However, this blew up because the current JavaScript implementation depends on Go templating to build an array of tags:</p><pre><code>let tags = [{{ range $name, $_ := $.Site.Taxonomies.tags }}{{ $name }},{{ end }}]
</code></pre><p>And processing this with <a href=https://gohugo.io/hugo-pipes/js/>js.Build</a> fails because it&rsquo;s not valid JavaScript.</p><h2 id=heading-1></h2><h2 id=a-better-way-to-inject-site-content-into-javascript>A better way to inject site content into JavaScript</h2><p>Turns out Hugo Pipes supports passing a map of params to js.Build, and those params can be accessed in JavaScript with the
<code>import</code> keyword. So all together we get:</p><pre><code>{{ $tags := slice }}
{{ range $name, $_ := $.Site.Taxonomies.tags }}
  {{ $tags = $tags | append $name }} 
{{ end }}

{{ $main := resources.Get &quot;js/main.js&quot; | js.Build (dict &quot;params&quot; (dict &quot;tags&quot; $tags)) | minify | fingerprint }}
&lt;script type=&quot;text/javascript&quot; src=&quot;{{ $main.RelPermalink }}&quot; defer&gt;&lt;/script&gt;
</code></pre><p>And in JavaScript we just import the tags array:</p><pre><code>import {tags} from '@params';
</code></pre><h2 id=heading-2></h2><h2 id=bundling-css>Bundling CSS</h2><p>The site uses (2) CSS files:</p><ul><li>Skeleton CSS for a basic foundation, served from a CDN</li><li>Local styles in <code>main.css</code></li></ul><p>I moved both stylesheets into <code>./assets/css/</code> and then bundled, minified, and fingerprinted
with Hugo Pipes:</p><pre><code>{{ $skeleton := resources.Get &quot;css/skeleton.css&quot; }}
{{ $style := resources.Get &quot;css/main.css&quot; }}
{{ $css := slice $skeleton $style | resources.Concat &quot;css/bundle.css&quot; | minify | fingerprint }}
&lt;link rel=&quot;stylesheet&quot; href=&quot;{{ $css.Permalink }}&quot; integrity=&quot;{{ $css.Data.Integrity }}&quot;&gt;
</code></pre><h2 id=heading-3></h2><h2 id=bonus-removing-google-fonts>Bonus: Removing Google Fonts</h2><p>I also took this opportunity to replace the Google-hosted OpenSans font with
the system font stack, using the same technique as github.com:</p><pre><code>body {
  font-family: -apple-system,BlinkMacSystemFont,Segoe UI,Helvetica,Arial,sans-serif,Apple Color Emoji,Segoe UI Emoji;
}
</code></pre><h2 id=heading-4></h2><p>These changes, implemented in
<a href=https://github.com/bndw/len.to/commit/0b4e3002b03bb49ad08efc69e941f99e6a7c0da2>0b4e300</a> and
<a href=https://github.com/bndw/len.to/commit/0c29a6c13b4f2c20943d31fd073e0c721d17b002>0c29a6c</a>
produced faster page load times, improved user privacy, and generally better code quality.</p><h2 id=heading-5></h2></div></div></div><script src=/js/index.min.3b7c4c5b225f8bf2da6526a2c150baa14c455865ff51c949241dbef090474b74.js defer></script></body></html>