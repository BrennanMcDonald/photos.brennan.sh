<!doctype html><html><head><title>photos.brennan.sh</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robot content="noimageindex"><meta name=description content="photos.brennan.sh is a photography blog"><meta property="og:description" content="photos.brennan.sh is a photography blog"><meta property="og:site_name" content="photos.brennan.sh"><link rel=icon href=/favicon.svg><link rel=stylesheet href=https://photos.brennan.sh/css/bundle.min.a969df73a2e4412fd327742e002f7338c69bdc7206ca59b822e357f1faf8c657.css integrity="sha256-qWnfc6LkQS/TJ3QuAC9zOMab3HIGylm4IuNX8fr4xlc="></head><body><div class=container><div class=row><div class="three columns"><a class=title href=/>photos.brennan.sh</a></div></div><div class=row><div class="ten columns log"><h2>Validating Generated HTML</h2><p>I ran this website through an HTML validator and
discovered it was missing some closing <code>&lt;/div></code> tags. Tracking these errors down
can be challenging with generated HTML, so I decided to add linting to the build process and catch problems early.</p><h2 id=heading></h2><p>The <a href=https://validator.w3.org/nu/>Nu HTML Checker</a> I used above conveniently ships a
<a href=https://hub.docker.com/r/validator/validator/>Docker image</a> containing a CLI called <code>vnu</code>.
I ran into two small challenges integrating <code>vnu</code> in the multi-stage build:</p><h2 id=heading-1></h2><h2 id=1-vnu-wants-a-list-of-files>1. <code>vnu</code> wants a list of files</h2><p>According to the <a href=https://validator.github.io/validator/#usage>usage</a> vnu wants a list of files:</p><pre><code>vnu-runtime-image/bin/vnu OPTIONS FILES
</code></pre><p>However Hugo produces a <code>public</code> directory containing a tree of HTML.
To work around this I used <code>find</code> to create a file containing a list of generated HTML files:</p><pre><code>RUN find /build/public -type f -name &quot;*.html&quot; &gt; /tmp/htmlfiles.txt
</code></pre><p>Now we can just <code>cat /tmp/htmlfiles.txt</code> and pass the output to <code>vnu</code></p><h2 id=heading-2></h2><h2 id=2-validatorvalidator-is-based-on-a-distroless-image>2. <code>validator/validator</code> is based on a &ldquo;distroless&rdquo; image</h2><p>The <a href=https://hub.docker.com/r/validator/validator/>validator/validator</a> image is based on <code>gcr.io/distroless/base</code> and doesn&rsquo;t have <code>cat</code>, so instead I grabbed it from the previous build stage:</p><pre><code>COPY --from=build /bin/cat /bin/cat
</code></pre><p>Finally, we can run <code>vnu</code> with a list of all generated HTML:</p><pre><code>RUN vnu-runtime-image/bin/vnu --verbose --errors-only $(cat /tmp/htmlfiles.txt)
</code></pre><p>All said and done, here&rsquo;s what the Dockerfile&rsquo;s validator stage looks like:</p><pre><code>FROM validator/validator:latest as validator
COPY --from=build /bin/cat /bin/cat
COPY --from=build /build/public /build/public
COPY --from=build /tmp/htmlfiles.txt /tmp/htmlfiles.txt
RUN vnu-runtime-image/bin/vnu --verbose --errors-only $(cat /tmp/htmlfiles.txt)
</code></pre><h2 id=heading-3></h2><h2 id=heading-4></h2><p>With validation now in place for every generated HTML file, I discovered and fixed 8 existing errors.
Here&rsquo;s <a href=https://github.com/bndw/len.to/commit/e5a5187c22567668587e8dbc7819f58dc7e03b62>the commit</a> implementing HTML validation and the associated bug fixes.</p><h2 id=heading-5></h2></div></div></div><script src=/js/index.min.6fd5a5fea3701a3b80ec446ac4890a26183b9a4efd0a006a59992f01ca91d460.js defer></script></body></html>